<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<title>Lovicash: A web-based peer-to-peer Electronic Cash System</title>
</head>
<body>
	<script src="utils/indexed-db/IndexedDB.js"></script>
	<script src="utils/indexed-db/ObjectDB.js"></script>
	<script src="utils/indexed-db/storage-persistence.js"></script>
	<script src="utils/Observable.js"></script>
	<script src="utils/Synchronizer.js"></script>
	<script src="utils/array/IndexedArray.js"></script>
	<script src="utils/buffer/Buffer.js"></script>
	<script src="utils/buffer/BufferUtils.js"></script>
	<script src="utils/crypto/crypto.js"></script>
	<script src="utils/number/NumberUtils.js"></script>
	<script src="utils/object/ObjectUtils.js"></script>
	<script src="consensus/primitive/Primitive.js"></script>
	<script src="consensus/primitive/Hash.js"></script>
	<script src="consensus/primitive/PrivateKey.js"></script>
	<script src="consensus/primitive/PublicKey.js"></script>
	<script src="consensus/primitive/Signature.js"></script>
	<script src="consensus/account/Accounts.js"></script>
	<script src="consensus/account/AccountsTree.js"></script>
	<script src="consensus/account/AccountsTreeStore.js"></script>
	<script src="consensus/account/Address.js"></script>
	<script src="consensus/account/Balance.js"></script>
	<script src="consensus/block/BlockBody.js"></script>
	<script src="consensus/block/BlockHeader.js"></script>
	<script src="consensus/block/Block.js"></script>
	<script src="consensus/blockchain/Blockchain.js"></script>
	<script src="consensus/blockchain/BlockchainStore.js"></script>
	<script src="consensus/transaction/Transaction.js"></script>
	<script src="p2p/message/P2PMessage.js"></script>
	<script src="p2p/message/BlockP2PMessage.js"></script>
	<script src="p2p/message/GetBlocksP2PMessage.js"></script>
	<script src="p2p/message/InventoryP2PMessage.js"></script>
	<script src="p2p/message/VersionP2PMessage.js"></script>
	<script src="p2p/message/P2PMessageFactory.js"></script>
	<script src="p2p/webrtc/certificate/webrtc-certificate.js"></script>
	<script src="p2p/webrtc/peer-portal/PeerPortal.js"></script>
	<script src="p2p/P2PAgent.js"></script>
	<script src="p2p/P2PChannel.js"></script>
	<script src="p2p/P2PNetwork.js"></script>
	<script src="p2p/struct/InvVector.js"></script>
	<script src="consensus/Consensus.js"></script>
	<script src="miner/Miner.js"></script>
	<script src="miner/policy.js"></script>
	<script src="wallet/Wallet.js"></script>
	<!-- <script src="core.js"></script> -->

	<style type="text/css">
		body{
			padding: 5% 12%;
			background: #efefef;
			font-family: sans-serif;
		}

		#lastBlocks{
			display: flex;
			flex-direction: column-reverse;
		}

		#startButton {
			margin-bottom: 5px;
		}

		.info-title {
			font-size: 20pt;
			margin: 15px 0 10px 0;
		}

		hash {
			font-size: 12px;
		}
	</style>

	<div class="info">
		<div class="info-title">Blockchain</div>

		<div class="info-block"></div>
			<strong>Total work</strong>
			<span id="bcTotalWork"></span>
		</div>
		<div class="info-block"></div>
			<strong>Height</strong>
			<span id="bcHeight"></span>
		</div>
		<div class="info-block"></div>
			<strong>Accounts Hash</strong>
			<hash id="bcAccountsHash"></hash>
		</div>
	</div>

	<div class="info">
		<div class="info-title">Head Block</div>

		<div class="info-block"></div>
			<strong>Hash</strong>
			<hash id="hdHash"></hash>
		</div>
		<div class="info-block"></div>
			<strong>Prev Hash</strong>
			<hash id="hdPrevHash"></hash>
		</div>
		<div class="info-block"></div>
			<strong>Accounts Hash</strong>
			<hash id="hdAccountsHash"></hash>
		</div>
		<div class="info-block"></div>
			<strong>Difficulty</strong>
			<span id="hdDifficulty"></span>
		</div>
		<div class="info-block"></div>
			<strong>Timestamp</strong>
			<span id="hdTimestamp"></span>
		</div>
		<div class="info-block"></div>
			<strong>Nonce</strong>
			<span id="hdNonce"></span>
		</div>
	</div>

	<div class="info">
		<div class="info-title">Network</div>

		<div class="info-block"></div>
			<strong>Peers</strong>
			<span id="netPeerCount"></span>
		</div>
	</div>

	<div class="info">
		<div class="info-title">Miner</div>

		<button id="startButton">Start Mining</button>

		<div class="info-block"></div>
			<strong>Working</strong>
			<span id="mnrWorking"></span>
		</div>

		<div class="info-block"></div>
			<strong>Hashrate</strong>
			<span id="mnrHashrate"></span> H/s
		</div>

		<div class="info-block"></div>
			<strong>Last block mined at</strong>
			<span id="mnrLastBlockTs"></span>
		</div>

	</div>


	<div class="info">
		<div class="info-title">Block History</div>
		<div id="lastBlocks"></div>
	</div>


	<script type="text/javascript">
		class MinerUI {
			constructor($) {
				$.blockchain.on('head-changed', head => this._headChanged(head));
				$.network.on('peers-changed', () => this._peersChanged());

				$.miner.on('start', () => this._minerChanged());
				$.miner.on('stop', () => this._minerChanged());
				$.miner.on('hashrate-changed', () => this._minerChanged());
				$.miner.on('block-mined', () => this._blockMined());

				this._bcTotalWork = document.querySelector('#bcTotalWork');
				this._bcHeight = document.querySelector('#bcHeight');
				this._bcAccountsHash = document.querySelector('#bcAccountsHash');

				this._hdHash = document.querySelector('#hdHash');
				this._hdPrevHash = document.querySelector('#hdPrevHash');
				this._hdAccountsHash = document.querySelector('#hdAccountsHash');
				this._hdDifficulty = document.querySelector('#hdDifficulty');
				this._hdTimestamp = document.querySelector('#hdTimestamp');
				this._hdNonce = document.querySelector('#hdNonce');

				this._netPeerCount = document.querySelector('#netPeerCount');

				this._mnrWorking = document.querySelector('#mnrWorking');
				this._mnrHashrate = document.querySelector('#mnrHashrate');
				this._mnrLastBlockTs = document.querySelector('#mnrLastBlockTs');

				this._lastBlocks = document.querySelector('#lastBlocks');

				this._headChanged($.blockchain.head);
				this._peersChanged();
				this._minerChanged();

				this._startButton = document.querySelector('#startButton');
				this._startButton.onclick = e => this._toggleMining($);
			}

			_headChanged(head) {
				this._bcTotalWork.innerText = $.blockchain.totalWork;
				this._bcHeight.innerText = $.blockchain.height;
				this._bcAccountsHash.innerText = $.blockchain.accountsHash.toBase64();

				this._hdHash.innerText = $.blockchain.headHash.toBase64();
				this._hdPrevHash.innerText = $.blockchain.head.prevHash.toBase64();
				this._hdAccountsHash.innerText = $.blockchain.head.accountsHash.toBase64();
				this._hdDifficulty.innerText = $.blockchain.head.difficulty;
				this._hdTimestamp.innerText = new Date($.blockchain.head.timestamp * 1000);
				this._hdNonce.innerText = $.blockchain.head.nonce;

				const el = document.createElement('div');
				const date = new Date(head.timestamp * 1000);
				el.innerHTML =`<b>${date}</b> hash=<hash>${$.blockchain.headHash.toBase64()}</hash>, `
					+ `prev=<hash>${head.prevHash.toBase64()}</hash>, difficulty=${head.difficulty}, `
					+ `nonce=${head.nonce}`;
				this._lastBlocks.appendChild(el);
			}

			_toggleMining($){
				if(!this._isMining){
					this._isMining = true;
					$.miner.startWork();
					this._startButton.innerText = 'Stop Mining';
				}else{
					this._isMining = false;
					$.miner.stopWork();
					this._startButton.innerText = 'Start Mining';
				}
			}

			_peersChanged() {
				this._netPeerCount.innerText = $.network.peerCount;
			}

			_minerChanged() {
				this._mnrWorking.innerText = $.miner.working;
				this._mnrHashrate.innerText = $.miner.hashrate;
				this._mnrLastBlockTs.innerText = this._lastBlockMinedTs ?
					new Date(this._lastBlockMinedTs) : '-';
			}

			_blockMined() {
				this._lastBlockMinedTs = Date.now();
				this._minerChanged();
			}
		}
		Consensus.test().then( $ => {
			window.$ = $;
			const ui = new MinerUI($);
		});

	</script>
</body>
</html>
